-- üí• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå GUI ‡∏ã‡πâ‡∏≠‡∏ô
pcall(function()
    for _, gui in ipairs(gethui():GetChildren()) do
        if gui:IsA("ScreenGui") and gui:FindFirstChild("MainFrame") then
            gui:Destroy()
        end
    end
end)

-- üî± ‡πÇ‡∏´‡∏•‡∏î Kavo UI
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("üåü Macro Controller", "Midnight")

-- üìÅ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
local UIS = game:GetService("UserInputService")
local VIM = game:GetService("VirtualInputManager")
local Mouse = game.Players.LocalPlayer:GetMouse()
local RS = game:GetService("RunService")

local macro = {}
local recording = false
local playing = false
local autoPlayAgain = false
local lastTime = tick()

-- üé¨ ‡∏£‡∏∞‡∏ö‡∏ö Record
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and recording then
        if input.UserInputType == Enum.UserInputType.Keyboard then
            table.insert(macro, {
                time = tick() - lastTime,
                type = "key",
                key = input.KeyCode.Name
            })
            lastTime = tick()
        end
    end
end)

Mouse.Button1Down:Connect(function()
    if recording then
        table.insert(macro, {
            time = tick() - lastTime,
            type = "click",
            position = Mouse.Hit.Position
        })
        lastTime = tick()
    end
end)

-- üîÅ ‡∏£‡∏∞‡∏ö‡∏ö Playback
local function playMacro()
    if playing or #macro == 0 then return end
    playing = true

    coroutine.wrap(function()
        for _, action in ipairs(macro) do
            task.wait(action.time)
            if action.type == "key" then
                VIM:SendKeyEvent(true, Enum.KeyCode[action.key], false, game)
                VIM:SendKeyEvent(false, Enum.KeyCode[action.key], false, game)
            elseif action.type == "click" and action.position then
                VIM:SendMouseButtonEvent(action.position.X, action.position.Y, 0, true, game, 0)
                VIM:SendMouseButtonEvent(action.position.X, action.position.Y, 0, false, game, 0)
            end
        end
        playing = false
    end)()
end

-- ‚ñ∂Ô∏è Auto Play Again
local function tryPlayAgain()
    for _, d in pairs(game:GetDescendants()) do
        if d:IsA("TextButton") and d.Text:lower():find("play again") then
            firesignal(d.MouseButton1Click)
            break
        end
    end
end

-- üìå UI Setup
local MainTab = Window:NewTab("Main")
local MacroSection = MainTab:NewSection("üéÆ Macro Controls")

MacroSection:NewButton("‚ñ∂Ô∏è Start Macro", "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà", function()
    macro = {}
    lastTime = tick()
end)

MacroSection:NewButton("üîÅ Play Macro", "‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥", function()
    playMacro()
end)

MacroSection:NewToggle("‚è∫Ô∏è Record", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", function(state)
    recording = state
    lastTime = tick()
end)

MacroSection:NewToggle("üîÇ Auto Play Again", "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ", function(state)
    autoPlayAgain = state
end)

-- ‚öôÔ∏è Settings
local SettingsTab = Window:NewTab("Settings")
SettingsSection:NewDropdown("Select Mode", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î", {"Easy", "Normal", "Hard", "Insane"}, function(selected)
    currentMode = selected

    -- ‡∏•‡∏π‡∏õ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
    for _, btn in ipairs(game:GetDescendants()) do
        if btn:IsA("ImageButton") and btn.Name:lower():find(selected:lower()) then
            firesignal(btn.MouseButton1Click)
            print("‚úîÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏´‡∏°‡∏î:", selected)
            return
        end
    end

    -- fallback: ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏°‡∏µ TextLabel ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô
    for _, btn in ipairs(game:GetDescendants()) do
        if btn:IsA("ImageButton") then
            local label = btn:FindFirstChildWhichIsA("TextLabel", true)
            if label and label.Text:lower():find(selected:lower()) then
                firesignal(btn.MouseButton1Click)
                print("‚úîÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ú‡πà‡∏≤‡∏ô label:", selected)
                return
            end
        end
    end

    warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î:", selected)
end)

-- ‚ÑπÔ∏è About
local AboutTab = Window:NewTab("About")
local Info = AboutTab:NewSection("üìå Info")
Info:NewLabel("Macro by ‡πÑ‡∏≠‡∏≠‡πâ‡∏ß‡∏á & ‡πÄ‡∏Ñ‡πâ‡∏≤ üíñ")

-- üéØ Hotkey Toggle UI
local shown = true
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.RightShift then
        local gui = gethui():FindFirstChild("MainFrame", true)
        if gui then gui.Visible = not gui.Visible end
    end
end)

-- üîÅ ‡∏ß‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô
RS.RenderStepped:Connect(function()
    if autoPlayAgain then tryPlayAgain() end
end)
