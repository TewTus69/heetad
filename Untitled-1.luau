-- ğŸ’¥ à¸¥à¸š GUI à¸‹à¹‰à¸³à¸‹à¹‰à¸­à¸™
pcall(function()
	for _, gui in ipairs(game:GetService("CoreGui"):GetChildren()) do
		if gui:IsA("ScreenGui") and gui:FindFirstChild("MainFrame") then
			gui:Destroy()
		end
	end
end)

-- ğŸ”± à¹‚à¸«à¸¥à¸” Kavo UI
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("ğŸŒŠ Macro Controller", "Ocean")

-- âš™ï¸ à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Rep = game:GetService("ReplicatedStorage")
local remotes = Rep:WaitForChild("RemoteFunctions")

-- ğŸª§ Notification à¹à¸šà¸šà¹€à¸£à¸µà¸¢à¸šà¸«à¸£à¸¹
local notification = Instance.new("TextLabel")
notification.Parent = game:GetService("CoreGui")
notification.Size = UDim2.new(0, 300, 0, 40)
notification.Position = UDim2.new(0.5, -150, 0.05, 0)
notification.BackgroundColor3 = Color3.fromRGB(20, 60, 80)
notification.TextColor3 = Color3.fromRGB(255, 255, 255)
notification.Font = Enum.Font.GothamBold
notification.TextSize = 18
notification.Text = ""
notification.Visible = false
Instance.new("UICorner", notification)

local function notify(msg)
	notification.Text = msg
	notification.Visible = true
	task.delay(3, function()
		notification.Visible = false
	end)
end

-- ğŸ”§ à¸•à¸±à¸§à¹à¸›à¸£à¸«à¸¥à¸±à¸
local macroData = {}
local isRecording = false
local isPlaying = false
local autoPlayAgain = false
local autoStart = false
local currentMode = "Normal"
local lastRestart = 0
local restartCooldown = 10

-- ğŸ“ à¹à¸—à¹‡à¸š Main
local mainTab = Window:NewTab("Main")
local section = mainTab:NewSection("ğŸ® Macro Control")

section:NewButton("âºï¸ Start Record", "à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¡à¹‚à¸„à¸£", function()
	macroData = {}
	isRecording = true
	notify("âºï¸ à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§")
end)

section:NewButton("ğŸ›‘ Stop Record", "à¸«à¸¢à¸¸à¸”à¸šà¸±à¸™à¸—à¸¶à¸", function()
	isRecording = false
	notify("ğŸ›‘ à¸«à¸¢à¸¸à¸”à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§")
end)

section:NewButton("â–¶ï¸ Play Macro", "à¹€à¸¥à¹ˆà¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸", function()
	if #macroData == 0 then return notify("âš ï¸ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¡à¹‚à¸„à¸£") end
	isPlaying = true
	notify("â–¶ï¸ à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸¥à¹ˆà¸™à¹à¸¡à¹‚à¸„à¸£")
	coroutine.wrap(function()
		for _, act in ipairs(macroData) do
			task.wait(act.delay or 0.5)
			if act.type == "place" then
				remotes.PlaceUnit:InvokeServer(act.unit, act.data)
			elseif act.type == "upgrade" then
				remotes.UpgradeUnit:InvokeServer(act.unitId)
			elseif act.type == "sell" then
				remotes.SellUnit:InvokeServer(act.unitId)
			end
		end
		isPlaying = false
	end)()
end)

section:NewToggle("ğŸ” Auto Play Again", "à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸—à¹€à¸à¸¡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´", function(state)
	autoPlayAgain = state
	notify("ğŸ” Auto Play Again: " .. tostring(state))
end)

section:NewToggle("ğŸ§± Auto Select Mode", "à¹€à¸¥à¸·à¸­à¸à¸£à¸°à¸”à¸±à¸šà¹€à¸à¸¡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´", function(state)
	autoStart = state
	notify("ğŸ§± Auto Mode: " .. tostring(state))
end)

-- âš™ï¸ à¹à¸—à¹‡à¸š Settings
local settingsTab = Window:NewTab("Settings")
settingsTab:NewSection("âš™ï¸ Difficulty")
	:NewDropdown("Mode", "à¹€à¸¥à¸·à¸­à¸à¸£à¸°à¸”à¸±à¸š", {"Easy", "Normal", "Hard", "Insane"}, function(opt)
		currentMode = opt
		notify("âš™ï¸ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹‚à¸«à¸¡à¸”: " .. opt)
	end)

-- ğŸ“Œ à¹à¸—à¹‡à¸š About
Window:NewTab("About"):NewSection("âœ¦ Info")
	:NewLabel("à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢à¹„à¸­à¸­à¹‰à¸§à¸‡à¹à¸¥à¸°à¹€à¸„à¹‰à¸²à¹€à¸­à¸‡ ğŸ’™")

-- ğŸ® Hook Remote à¸ªà¸³à¸«à¸£à¸±à¸šà¸šà¸±à¸™à¸—à¸¶à¸
local oldPlace = remotes.PlaceUnit.InvokeServer
remotes.PlaceUnit.InvokeServer = function(_, unit, data)
	if isRecording then
		table.insert(macroData, {
			type = "place",
			unit = unit,
			data = data,
			delay = 0.3
		})
	end
	return oldPlace(remotes.PlaceUnit, unit, data)
end

local oldUpgrade = remotes.UpgradeUnit.InvokeServer
remotes.UpgradeUnit.InvokeServer = function(_, unitId)
	if isRecording then
		table.insert(macroData, {
			type = "upgrade",
			unitId = unitId,
			delay = 0.2
		})
	end
	return oldUpgrade(remotes.UpgradeUnit, unitId)
end

local oldSell = remotes.SellUnit.InvokeServer
remotes.SellUnit.InvokeServer = function(_, unitId)
	if isRecording then
		table.insert(macroData, {
			type = "sell",
			unitId = unitId,
			delay = 0.2
		})
	end
	return oldSell(remotes.SellUnit, unitId)
end

-- ğŸ•¹ï¸ RenderStep à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸«à¸¡à¸”à¹à¸¥à¸°à¹€à¸¥à¹ˆà¸™à¸‹à¹‰à¸³
RS.RenderStepped:Connect(function()
	if autoStart then
		local ok = pcall(function()
			remotes.PlaceDifficultyVote:InvokeServer("dif_" .. currentMode:lower())
		end)
		if ok then
			notify("âœ… à¹‚à¸«à¸§à¸•à¹‚à¸«à¸¡à¸” " .. currentMode)
			autoStart = false
		end
	end

	if autoPlayAgain and tick() - lastRestart > restartCooldown then
		local success, err = pcall(function()
			remotes.RestartGame:InvokeServer()
		end)
		if success then
			lastRestart = tick()
			notify("ğŸ” à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸—à¹€à¸à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!")
		else
			notify("âš ï¸ à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸—à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: " .. tostring(err))
		end
	end
end)

-- âŒ¨ï¸ à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡ UI
UIS.InputBegan:Connect(function(input, gp)
	if not gp and input.KeyCode == Enum.KeyCode.RightShift then
		Window:Toggle()
	end
end)
